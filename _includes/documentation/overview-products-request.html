<h3>Faceted search</h3>
<p>
    Many names refer to the same thing. Faceting is sometimes also called “Faceted Search”,
    “Parameter Search”, “Faceted Navigation” and others. What it is about is best explained with a
    common use case of our context:
    <br>
    If you send off a ProductRequest with a facet “Brand”, then you not only get back the
    products that match the search criteria, but on top an overview, what brands occur among all found
    products and how often. Up to 50 different brands will be returned, together with the quantity of
    products for each brand - depending on the input parameter <code>$facetValueLimit</code>.
    <br>
    By default 20 Facet values will be returned

</p>
<p><strong>Example</strong></p>

{% highlight php linenos %}
<?php

$search = new \Affilinet\ProductData\Requests\ProductsRequest($affilinet);

// add the band facet and show a maximum of 15 different brands
$search->addFacetBrand(15);

// Create a query for the Product Search Request
$query = new \Affilinet\ProductData\Requests\Helper\Query();
$query->where($query->exactly('T-Shirt'));
$search->query( $query);

// will return a Product Response Object
$productResponse = $search->send();

// display the brand and the number of results for each brand
foreach ($productResponse->getFacets() as $facet) {
    echo $facet->getName();

    foreach ($facet->getValues() as $facetValue) {
        echo $facetValue->getDisplayValue(). ' (' .$facetValue->getResultCount() . ')';
    }
}

// show the results
foreach ($productResponse->products() as $product) {
    echo $product->getProductName();
    echo $product->getPriceInformation()->getDisplayPrice();
}
{% endhighlight %}


<div role="alert" class="alert alert-warning">
    <strong>Warning!</strong> <br>
    You can only add up to <strong>4</strong> facets to each search request.
</div>

<p>
    Facets can not only be added for Brand. You can choose between these facets
</p>
<ul>
    <li><code>$search->addFacetArticleNumber()</code></li>
    <li><code>$search->addFacetBrand()</code></li>
    <li><code>$search->addFacetDistributor()</code></li>
    <li><code>$search->addFacetEAN()</code></li>
    <li><code>$search->addFacetManufacturer()</code></li>
    <li><code>$search->addFacetShopId()</code></li>
    <li><code>$search->addFacetAffilinetCategoryId()</code></li>
    <li><code>$search->addFacetAffilinetCategoryPath()</code></li>
    <li><code>$search->addFacetShopCategoryId()</code></li>
    <li><code>$search->addFacetShopCategoryPath()</code></li>

    <li><code>Deprecated: $search->addFacetShopName()</code></li>
    <li><code>Deprecated: $search->addFacetProgramId()</code></li>
</ul>

<h3>Generating facet links</h3>
<p>
   By now we just displayed the result count for each facet.
    For sure you want to use these facets as a filter on your page.

    <br>
    To make this work you will have to convert each facet into an URL.
    There are several ways to achieve this

</p>

<h4>Using the build in querystring generator</h4>
<div role="alert" class="alert alert-info">
    You should use your own implementation to generate facet URLs. The method <code>generateQueryString()</code>
    is just included for your convenience.
</div>

{% highlight php linenos %}
<?php

foreach ($productResponse->getFacets() as $facet) {
    echo $facet->getName();

    foreach ($facet->getValues() as $facetValue) {
        // generate a query string and attach it to your URL
        $url = '/' . $facetValue->generateQueryString($search);

        echo "<a href='$url'> ". $facetValue->getDisplayValue() . '</a><br>';
    }
}

{% endhighlight %}


<h4>Using a custom routing component (the better way) </h4>

{% highlight php linenos %}
<?php

foreach ($productResponse->getFacets() as $facet) {
    echo $facet->getName();

    foreach ($facet->getValues() as $facetValue) {
        // generate a new ProductSearchRequest for each facetValue
        $newProductSearchRequestString = $facetValue->generateSerializedSearchProductsRequest($search);

        // use the serialized Object to generate the ProductSearchRequest object
        $newProductSearchRequest = new \Affilinet\ProductData\Requests\ProductsRequest($affilinet);
        $newProductSearchRequest->unserialize($newProductSearchRequestString);

        // use  $newProductSearchRequest or $newProductSearchRequestString to generate an URL with your router
        $url = YourRouter::generateURL($newProductSearchRequest);

        echo "<a href='$url'> ". $facetValue->getDisplayValue() . '</a><br>';
    }
}

{% endhighlight %}

<h3>Generate the resultpage for facet links</h3>
<p>
    The actually display the results behind these links you will have to extract the information from the URL and
    create a new ProductSearchRequest.
    <br>
    For testing purposes you can create a ProductSearchRequest directly from the query string:
</p>

{% highlight php linenos %}
<?php
// create a Product Search Request Object
$search = new \Affilinet\ProductData\Requests\ProductsRequest($affilinet);
// !!! DO NOT USE IN PRODCTION !!!
$search->unserialize($_SERVER['QUERY_STRING']);
// !!! DO NOT USE IN PRODCTION !!!
$products = $search->send();

{% endhighlight %}

<div role="alert" class="alert alert-danger">
    <strong>Warning</strong>
    <br>Do not use this code in production. Instead implement your own URL generator and ProductSearchRequest generator.

</div>