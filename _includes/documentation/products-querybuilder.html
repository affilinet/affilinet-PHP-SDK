<p>
    The SDK provides a Query Builder to easily generate complex SQL-like search requests.
</p>

<div class="well well-sm">
    The Query Builder should not be combined with the <a href="#products-facets">facet querystring generator</a>.

</div>


<p> Include terms </p>
{% highlight php  %}
<?php
$query = new \Affilinet\ProductData\Requests\Helper\Query();

$query->where(
        $query->expr()->containsAllOf('ipad', 'apple')
);

$productsRequest
    ->query($query)
    ->send();

{% endhighlight %}
<br>
<br>

<p>Alternativly you can chain expressions</p>
{% highlight php  %}
<?php
$query = new \Affilinet\ProductData\Requests\Helper\Query();
$query->where(
    $query->expr()
        ->contains('ipad')
        ->contains('apple')
);

$productsRequest
    ->query($query)
    ->send();

{% endhighlight %}
<br>
<br>



<p> Exactly match a term </p>
{% highlight php  %}
<?php
$query = new \Affilinet\ProductData\Requests\Helper\Query();
// will include apple but not applejuice
$query->where(
    $query
        ->expr()
        ->exactly('apple')
);
{% endhighlight %}
<br>
<br>


<p> Combine terms with OR </p>
{% highlight php  %}
<?php
$query = new \Affilinet\ProductData\Requests\Helper\Query();
// will include results matching apple or samsung
$query->where(
    $query
        ->expr()
        // you can add as many parameters as you like or an array
        ->containsOneOf('apple', 'samsung')
);
{% endhighlight %}
<br>
<br>


<p> Exclude terms </p>
{% highlight php  %}
<?php
$query = new \Affilinet\ProductData\Requests\Helper\Query();
$query->where(
    $query
        ->expr()
        // you can add as many parameters as you like or an array
        ->containsNot('ipad', 'apple')
);

{% endhighlight %}
<br>
<br>



<p>
    <strong>Examples</strong><br>
    Get all products containing "apple" but not containing "ipod", "iphone", "mac"
</p>

{% highlight php linenos %}
<?php
$productsRequest = new \Affilinet\ProductData\Requests\ProductsRequest($affilinet);
$query = new \Affilinet\ProductData\Requests\Helper\Query();
$query
    ->where(
        $query
            ->expr()
            ->contains('apple')
            // you can add as many parameters as you like or an array
            ->containsNot('ipod', 'iphone', 'mac', 'iPad' )
    );
$productsRequest->query($query);

$response = $productsRequest->send();

{% endhighlight %}

<br>
<br>
<p>
    Get all products containing "apple"  and "ipad"
</p>
{% highlight php %}
<?php
$productsRequest = new \Affilinet\ProductData\Requests\ProductsRequest($affilinet);
$query = new \Affilinet\ProductData\Requests\Helper\Query();
$query
    ->where(
        $query
            ->expr()
            ->contains('apple')
            ->contains('ipad')
    );
$response = $productsRequest->query($query)->send();

{% endhighlight %}
<br>
<br>




<p>
    <strong>Chain Query Expressions</strong> <br>
</p>


<div class="well well-sm">
    For better code legibility both methods <pre>where()</pre> and <pre>andWhere()</pre> can be used. They provide the same functionality.</a>.
</div>

<p>Chaining with AND</p>

{% highlight php  %}
<?php
$productsRequest = new \Affilinet\ProductData\Requests\ProductsRequest($affilinet);
$productsRequest->query($query
->where($query->expr()
->contains('apple')
)
->andWhere($query->expr()
->exactly('iphone')
)
);
$response = $productsRequest->query($query)->send();
{% endhighlight %}


<br>
<br>

<p>
    Combine with OR: Find (apple and "iphone") or (samsung and "galaxy")
</p>
{% highlight php  %}
<?php
$productsRequest = new \Affilinet\ProductData\Requests\ProductsRequest($affilinet);
$query = new \Affilinet\ProductData\Requests\Helper\Query();
$query
    ->where($query->epxr()
        ->contains('apple')
        ->exactly('iphone')
    )
    ->orWhere($query->expr()
        ->contains('samsung')
        ->exactly('galaxy')
    );
$response = $productsRequest->query($query)->send();

{% endhighlight %}
<br>
<br>


<p> Combine  OR with AND. The SQL would look </p>
<pre>
    ( "t-mobile")

    AND
    (
        (  apple AND "iphone" )
        OR
        (  samsung AND "galaxy" )

    )
</pre>


{% highlight php  %}
<?php
$productsRequest = new \Affilinet\ProductData\Requests\ProductsRequest($affilinet);
$query = new \Affilinet\ProductData\Requests\Helper\Query();
$query
    ->where($query->expr()
        ->contains('apple')
        ->exactly('iphone')
        ->exactly('t-mobile')
    )
    ->orWhere($query->expr()
        ->contains('samsung')
        ->exactly('galaxy')
        ->exactly('t-mobile')
    )
);
$response = $productsRequest->query($query)->send();
{% endhighlight %}

<br>
<br>

<p>
    <strong>Limitations</strong>
    <br>
It is <strong>not possible to nest where statements</strong>: "No <pre>where()</pre> inside of <pre>where()</pre> methods.
They only accept expression statements "<pre>expr()</pre>".
</p>

{% highlight php  %}
<?php
$productsRequest = new \Affilinet\ProductData\Requests\ProductsRequest($affilinet);
$query = new \Affilinet\ProductData\Requests\Helper\Query();

// invalid code!
$query->where(
    $query
        ->expr()
        ->contains('apple')
        // next line will not work:
        ->orWhere(
            $query
                ->expr()
                ->contains('samsung')
        );


{% endhighlight %}
<br>
<br>

<p>
It is not possible to chain expressions inside a <pre>where()</pre> with OR.
</p>
{% highlight php  %}
<?php
$productsRequest = new \Affilinet\ProductData\Requests\ProductsRequest($affilinet);
$query = new \Affilinet\ProductData\Requests\Helper\Query();

// invalid code!
$query->where(
    $query
        ->expr()
        ->contains('apple')
        ->orContains('samsung) // !!! method not defined !!!
);

// correct code:
$query->where(
    $query
        ->expr()
        ->containsOneOf('apple', 'samsung')

);

// alternate correct code:
$query
    ->where($query->expr()->contains('apple'));
    ->orWhere($query->expr()->contains('samsung'));

);

{% endhighlight %}


<p>
    <strong>Write queries by yourself</strong><br>
    Instead of using the query builder you can write queries by yourself and attach them via
    <br>
    <code>$productsRequest->addRawQuery(YOUR_QUERY_STRING)</code>
<br>
    The keyword(s) you want the products to match. Can be
    any length. The following search operators are supported:
    <ul>
    <li><strong>AND</strong> (both query tokens must be contained in the
        product, but not necessarily next to one another)</li>
    <li><strong>OR</strong> (any of the query tokens must be contained in the
        product)</li>
    <li><strong>NOT</strong> (e.g. with “ipod AND NOT nano”, you will get
        products, which match the query “ipod”, but at the
        same time don’t match “nano”)</li>
    <li><strong>"</strong>
        (phrase match: all query tokens inclosed with double
        quotes must be contained in the found products in
        that order)</li>
    <li><strong>()</strong> Parentheses, to group expressions</li>
</ul>
So you can formulate a query like this:
<br>
<code>"apple ipod" ((touch OR classic) NOT nano) AND "32 GB"</code>
<br>
ProductsRequest supports the wildcard ‘*’ for suffix
matching, that is: a query ‘bott*’ will match for products,
which contain the word “bottle” or the word “bottom”.
Search operators “AND”, “OR” and “NOT” must be in
capital letters.

</p>

{% highlight php  %}
<?php
$productsRequest
    ->addRawQuery(
        ' "apple ipod" ((touch OR classic) NOT nano) AND  "32 GB"'
    );

{% endhighlight %}

<br>
<br>