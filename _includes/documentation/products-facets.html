<p>
    Many names refer to the same thing. Faceting is sometimes also called “Faceted Search”,
    “Parameter Search”, “Faceted Navigation” and others. What it is about is best explained with a
    common use case of our context:
    <br>
    If you send off a ProductRequest with a facet “Brand”, then you not only get back the
    products that match the search criteria, but on top an overview, what brands occur among all found
    products and how often. Up to 50 different brands will be returned, together with the quantity of
    products for each brand - depending on the input parameter <code>$facetValueLimit</code>.
    By default 20 Facet values will be returned
</p>

<div role="alert" class="alert alert-warning">
    <strong>Warning!</strong> <br>
    You can only add up to <strong>4</strong> facets to each search request.
</div>

<p><strong>Example</strong></p>

{% highlight php linenos %}
<?php

$search = new \Affilinet\ProductData\Requests\ProductsRequest($affilinet);

// add the band facet and show a maximum of 15 different brands
$search->addFacetBrand(15);

// Create a query for the ProductsRequest
$query = new \Affilinet\ProductData\Requests\Helper\Query();
$query->where($query->exactly('T-Shirt'));
$search->query( $query);

// will return a ProductsResponse Object
$productsResponse = $search->send();

// display the brand and the number of results for each brand
foreach ($productsResponse->getFacets() as $facet) {
    echo $facet->getName();

    foreach ($facet->getValues() as $facetValue) {
        echo $facetValue->getDisplayValue(). ' (' .$facetValue->getResultCount() . ')';
    }
}

// show the results
foreach ($productsResponse->products() as $product) {
    echo $product->getProductName();
    echo $product->getPriceInformation()->getDisplayPrice();
}
{% endhighlight %}




<p>
    Facets can not only be added for Brand. You can choose up to four of these facets
</p>
<ul>
    <li><code>$search->addFacetArticleNumber()</code></li>
    <li><code>$search->addFacetBrand()</code></li>
    <li><code>$search->addFacetDistributor()</code></li>
    <li><code>$search->addFacetEAN()</code></li>
    <li><code>$search->addFacetManufacturer()</code></li>
    <li><code>$search->addFacetShopId()</code></li>
    <li><code>$search->addFacetAffilinetCategoryId()</code></li>
    <li><code>$search->addFacetAffilinetCategoryPath()</code></li>
    <li><code>$search->addFacetShopCategoryId()</code></li>
    <li><code>$search->addFacetShopCategoryPath()</code></li>

    <li>Deprecated: <code>$search->addFacetShopName()</code></li>
    <li>Deprecated: <code>$search->addFacetProgramId()</code></li>
</ul>
<br>
<br>

<strong>Generating Facet Links</strong>
<p>
    By now we just displayed the result count for each facet.
    For sure you want to use these facets as a filter on your page.

    <br>
    To make this work you will have to convert each facet into an URL.
    There are several ways to achieve this.
    <div class="well well-sm">
        You should use your own implementation to generate facet URLs. The method <code>generateQueryString()</code>
        is just included for your convenience.
    </div>
</p>

<strong>Generate Facet Links with the querystring generator</strong>


{% highlight php linenos %}
<?php

foreach ($productResponse->getFacets() as $facet) {
echo $facet->getName();

foreach ($facet->getValues() as $facetValue) {
    // generate a query string and attach it to your URL
    $url = '/' . $facetValue->generateQueryString($search);

    echo "<a href='$url'> ". $facetValue->getDisplayValue() . '</a><br>';
    }
}

{% endhighlight %}


<strong>Generate Facet Links with a custom router (the better way) </strong>

{% highlight php linenos %}
<?php

foreach ($productResponse->getFacets() as $facet) {
    echo $facet->getName();

    foreach ($facet->getValues() as $facetValue) {
        // generate a new ProductRequest for each facetValue
        $newProductsRequestString = $facetValue->generateSerializedSearchProductsRequest($search);

        // use the serialized Object to generate the ProductSearchRequest object
        $newProductsRequest = new \Affilinet\ProductData\Requests\ProductsRequest($affilinet);
        $newProductsRequest->unserialize($newProductsRequestString);

        // use  $newProductsRequest or $newProductsRequestString to generate an URL with your router
        $url = YourRouter::generateURL($newProductsRequest);

        echo "<a href='$url'> ". $facetValue->getDisplayValue() . '</a><br>';
    }
}

{% endhighlight %}

<br>
<br>
<strong>Generate the resultpage for facet links</strong>
<p>
    To actually display the results behind these links you will have to extract the information from the URL and
    create a new ProductSearchRequest.
    For testing purposes you can create a ProductSearchRequest directly from the query string

</p>


{% highlight php linenos %}
<?php
// create a Product Search Request Object
$search = new \Affilinet\ProductData\Requests\ProductsRequest($affilinet);

$queryString = $_SERVER['QUERY_STRING']
// do not forget to sanatize the query string!
$search->unserialize($queryString);

$products = $search->send();

{% endhighlight %}
<br>
<br>
<strong>Matching Facets and FilterQueries</strong>
<p class="well-sm well">
    In your own solution you should use <code>addFilterQuery($name, $value)</code> to filter results according to the selected facets
</p>
    <strong>Example:</strong>
    <ul>
    <li>You have added the "Brand" Facet with <code>$search->addFacetBrand()</code>.</li>
    <li>A User clicks on on the facet with value "Adidas"</li>
    <li>On the resultpage you will have to add a filterQuery:  <code>$search->addFilterQuery('Brand', 'Adidas')</code></li>
    <li>The results will be filtered to 'Brand' === 'Adidas'</li>

</ul>

</p>